---
import LinkButton from "./LinkButton.astro";

interface Venue {
  name: string;
  address?: string;
  googleMapsLink?: string;
}

type EventStatus = "completed" | "failed" | "scheduled";

interface Props {
  eventNumber: number;
  date: Date;
  status?: EventStatus;
  primaryVenue: Venue;
  secondaryVenues?: Venue[];
  note?: string;
  attendees: string[];
  firstTimers?: string[];
}

const {
  eventNumber,
  date,
  primaryVenue,
  secondaryVenues,
  status = "scheduled",
  note,
  attendees,
  firstTimers = [],
} = Astro.props;

const statusLabels: Record<EventStatus, string> = {
  completed: "Completed",
  failed: "Failed",
  scheduled: "Booked",
};

const statusMeta: Partial<Record<EventStatus, string>> = {
  failed: "Plan changed on the day.",
  scheduled: "Booking secured, details locked.",
};

const statusBadge = status !== "completed" ? `status-badge--${status}` : "";
const eventToneClass = status !== "completed" ? `event--${status}` : "";

const leadingZeros = "0".repeat(Math.max(0, 3 - eventNumber.toString().length));

function formatDate(date: Date): string {
  const day = date.getDate();
  const month = date
    .toLocaleDateString("en-GB", { month: "short" })
    .toUpperCase();
  const year = date.getFullYear().toString().slice(-2);
  return `${day} ${month} ${year}`;
}
---

<li class:list={["event", eventToneClass]}>
  <div class="event-number">
    <span class="leading-zeros">{leadingZeros}</span>{eventNumber}
  </div>
  <div class="details">
    <div class="event-heading">
      <h2>{primaryVenue.name}</h2>
      <div>
        <time datetime={date.toISOString()}>
          {formatDate(date)}
        </time>
      </div>

      {
        primaryVenue.address && (
          <div class="primary-venue-info">
            {primaryVenue.address && (
              <address class="primary-venue-address">
                {primaryVenue.address}
              </address>
            )}

            {primaryVenue.googleMapsLink && (
              <a
                href={primaryVenue.googleMapsLink}
                target="_blank"
                rel="noopener nofollow"
              >
                Open in Maps
              </a>
            )}
          </div>
        )
      }
    </div>

    {
      status !== "completed" && (
        <div class="meta">
          <span class:list={["status-badge", statusBadge]}>
            {statusLabels[status]}
          </span>
          {statusMeta[status] && (
            <div>
              <span class="status-copy">{statusMeta[status]}</span>
            </div>
          )}
        </div>
      )
    }

    {
      note && (
        <div class={`note ${status === "failed" ? "note--failed" : ""}`}>
          {note}
        </div>
      )
    }
    {
      secondaryVenues && secondaryVenues.length > 0 && (
        <ul class="secondary-venues">
          {secondaryVenues.map((venue) => (
            <li>
              <div class="secondary-venue-info">
                <span class="secondary-venue-name">{venue.name}</span>
                {venue.address && (
                  <address class="secondary-venue-address">
                    {venue.address}
                  </address>
                )}

                {venue.googleMapsLink && (
                  <a
                    href={venue.googleMapsLink}
                    target="_blank"
                    rel="noopener nofollow"
                  >
                    Open in Maps
                  </a>
                )}
              </div>
            </li>
          ))}
        </ul>
      )
    }
  </div>
</li>

<style>
  .event {
    display: flex;
    align-items: flex-start;
    gap: var(--space-l);
  }

  .event-number {
    font-family: var(--font-body);
    font-size: calc(var(--text-section) * 1.15);
    font-variant-numeric: tabular-nums;
    font-weight: 700;
    letter-spacing: 0.05em;
    line-height: 1;
    color: var(--mustard-yellow);
  }

  .leading-zeros {
    color: rgba(255, 255, 255, 0.075);
  }

  .event-heading {
    display: flex;
    flex-direction: column;
    gap: var(--space-2xs);
    flex-wrap: wrap;
  }

  .details {
    display: flex;
    flex-direction: column;
    gap: var(--space-m);
  }

  .details h2 {
    font-size: var(--text-section);
    line-height: 1;
    text-wrap: balance;
  }

  .status-badge {
    padding: var(--space-3xs) var(--space-2xs);
    font-size: var(--text-ui);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    font-weight: 700;
    transform: rotate(-3deg);
    display: inline-block;
  }

  .status-badge--failed {
    border: 2px solid var(--electric-red);
    color: var(--electric-red);
    background: rgba(224, 79, 95, 0.08);
  }

  .status-badge--scheduled {
    border: 2px solid var(--carbon-black);
    background: var(--mustard-yellow);
    color: var(--carbon-black);
    box-shadow: 3px 3px 0px var(--carbon-black);
  }

  .meta {
    display: flex;
    align-items: center;
    gap: var(--space-s);
    flex-wrap: wrap;
  }

  .details time {
    opacity: 0.7;
    display: inline-block;
  }

  .status-copy {
    font-size: var(--text-ui);
    opacity: 0.7;
  }

  .primary-venue-info {
    display: flex;
    flex-direction: column;
    gap: var(--space-3xs);
    opacity: 0.7;
    font-size: var(--step--1);
  }

  .primary-venue-address {
    font-style: normal;
    opacity: 0.8;
  }

  .primary-venue-info a {
    text-decoration: underline;
    text-underline-offset: 0.2em;
    text-decoration-color: rgba(255, 255, 255, 0.4);
  }

  .secondary-venues {
    list-style: none;
    padding: 0;
    opacity: 0.7;
    font-size: var(--step--1);
    display: flex;
    flex-direction: column;
    gap: var(--space-s);
  }

  .secondary-venues li {
    display: flex;
    flex-direction: column;
  }

  .secondary-venue-info {
    display: flex;
    flex-direction: column;
    gap: var(--space-3xs);
  }

  .secondary-venue-name {
    font-weight: 500;
  }

  .secondary-venue-address {
    font-style: normal;
    opacity: 0.8;
  }

  .secondary-venues a {
    text-decoration: underline;
    text-underline-offset: 0.2em;
    text-decoration-color: rgba(255, 255, 255, 0.4);
  }

  .note {
    padding: var(--space-xs-s);
    background: rgba(255, 255, 255, 0.04);
    border: 1px solid rgba(255, 255, 255, 0.4);
    box-shadow: 3px 3px 0px var(--carbon-black);
    font-size: var(--text-ui);
    line-height: 1.6;
  }

  .note--failed {
    border-color: var(--electric-red);
    box-shadow: 3px 3px 0px var(--carbon-black);
    background: rgba(224, 79, 95, 0.08);
  }

  .attendees {
    margin-top: var(--space-m);
  }

  .attendees__label {
    font-size: var(--text-ui);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    opacity: 0.8;
    display: block;
    margin-bottom: var(--space-3xs);
  }

  .attendees__list {
    list-style: none;
    display: flex;
    gap: var(--space-3xs);
    padding: 0;
    flex-wrap: wrap;
    margin: 0;
  }

  .attendee {
    position: relative;
    border: 1px solid var(--stark-white);
    border-radius: 999px;
    font-size: var(--text-ui);
    display: inline-flex;
    align-items: center;
    gap: var(--space-4xs);
    background: rgba(255, 255, 255, 0.02);
    padding: var(--space-5xs) var(--space-5xs);
    transition: background 0.2s ease, box-shadow 0.2s ease;
  }

  .attendee:hover {
    background: rgba(255, 255, 255, 0.1);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
  }

  .attendee__avatar {
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    display: grid;
    place-items: center;
    background: var(--attendee-bg, var(--carbon-black));
    color: var(--attendee-fg, var(--stark-white));
    font-weight: 700;
    letter-spacing: 0.06em;
    border: 2px solid var(--stark-white);
    transition: transform 0.2s ease;
    position: relative;
    overflow: visible;
  }

  .attendee__name {
    max-width: 0;
    opacity: 0;
    overflow: hidden;
    white-space: nowrap;
    transition: max-width 0.25s ease, opacity 0.2s ease;
  }

  .attendee:hover .attendee__name {
    max-width: 12rem;
    opacity: 1;
    padding-right: var(--space-4xs);
  }

  .attendee:hover .attendee__avatar {
    transform: translateY(-1px);
  }

  .attendee__new {
    position: absolute;
    right: -0.2rem;
    top: -0.3rem;
    background: var(--mustard-yellow);
    color: var(--carbon-black);
    border: 2px solid var(--stark-white);
    border-radius: 999px;
    padding: 0.1rem 0.35rem;
    font-size: 0.65rem;
    font-weight: 800;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    pointer-events: none;
  }
</style>

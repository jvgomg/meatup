---
import LinkButton from './LinkButton.astro';

interface Venue {
  name: string;
  address?: string;
  googleMapsLink?: string;
}

type EventStatus = 'completed' | 'failed' | 'scheduled';

interface Props {
  eventNumber: number;
  date: Date;
  status?: EventStatus;
  primaryVenue: Venue;
  secondaryVenues?: Venue[];
  note?: string;
  attendees: string[];
  firstTimers?: string[];
}

const {
  eventNumber,
  date,
  primaryVenue,
  secondaryVenues,
  status = 'scheduled',
  note,
  attendees,
  firstTimers = [],
} = Astro.props;

const statusLabels: Record<EventStatus, string> = {
  completed: 'Completed',
  failed: 'Failed',
  scheduled: 'Booked',
};

const statusMeta: Partial<Record<EventStatus, string>> = {
  failed: 'Plan changed on the day.',
  scheduled: 'Booking secured, details locked.',
};

const statusBadge = status !== 'completed' ? `status-badge--${status}` : '';
const eventToneClass = status !== 'completed' ? `event--${status}` : '';
const firstTimerSet = new Set(firstTimers);

const attendeeColorMap: Record<string, { bg: string; fg: string }> = {
  Atlas: { bg: 'var(--mustard-yellow)', fg: 'var(--carbon-black)' },
  Morse: { bg: 'rgba(224, 79, 95, 0.9)', fg: 'var(--stark-white)' },
  Titan: { bg: 'rgba(255, 255, 255, 0.2)', fg: 'var(--stark-white)' },
  Ranger: { bg: 'rgba(0, 0, 0, 0.8)', fg: 'var(--mustard-yellow)' },
  Aster: { bg: 'rgba(255, 255, 255, 0.25)', fg: 'var(--carbon-black)' },
  Archer: { bg: 'rgba(224, 79, 95, 0.65)', fg: 'var(--carbon-black)' },
  Blaze: { bg: 'rgba(255, 205, 86, 0.25)', fg: 'var(--carbon-black)' },
  Moss: { bg: 'rgba(0, 0, 0, 0.65)', fg: 'var(--stark-white)' },
  Grove: { bg: 'rgba(255, 205, 86, 0.4)', fg: 'var(--carbon-black)' },
  Marlin: { bg: 'rgba(224, 79, 95, 0.55)', fg: 'var(--stark-white)' },
};

const fallbackPalette = [
  { bg: 'rgba(255, 255, 255, 0.15)', fg: 'var(--carbon-black)' },
  { bg: 'rgba(0, 0, 0, 0.7)', fg: 'var(--stark-white)' },
  { bg: 'rgba(224, 79, 95, 0.5)', fg: 'var(--stark-white)' },
  { bg: 'rgba(255, 205, 86, 0.35)', fg: 'var(--carbon-black)' },
];

const getAttendeeColors = (name: string) => {
  if (attendeeColorMap[name]) return attendeeColorMap[name];
  const hash = [...name].reduce((acc, char) => acc + char.charCodeAt(0), 0);
  return fallbackPalette[hash % fallbackPalette.length];
};
---

<li class:list={['event', eventToneClass]}>
  <div class="event-number">{eventNumber.toString().padStart(3, '0')}</div>
  <div class="details">
    <div class="event-heading">
      <h2>{primaryVenue.name}</h2>
      {status !== 'completed' && (
        <span class:list={['status-badge', statusBadge]}>{statusLabels[status]}</span>
      )}
    </div>
    <div class="meta">
      <time datetime={date.toISOString()}>
        {date.toLocaleDateString('en-GB', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        })}
      </time>
      {statusMeta[status] && <span class="status-copy">{statusMeta[status]}</span>}
    </div>
    {primaryVenue.googleMapsLink && (
      <div class="actions">
        <LinkButton href={primaryVenue.googleMapsLink} target="_blank" rel="noopener nofollow">Open in Maps</LinkButton>
      </div>
    )}
    {note && (
      <div class={`note ${status === 'failed' ? 'note--failed' : ''}`}>
        {note}
      </div>
    )}
    {secondaryVenues && secondaryVenues.length > 0 && (
      <ul class="secondary-venues">
        {secondaryVenues.map((venue) => (
          <li>
            <span>{venue.name}</span>
            {venue.googleMapsLink && (
              <a href={venue.googleMapsLink} target="_blank" rel="noopener nofollow">Open in Maps</a>
            )}
          </li>
        ))}
      </ul>
    )}
    {attendees.length > 0 && (
      <div class="attendees">
        <span class="attendees__label">Attendees</span>
        <ul class="attendees__list">
          {attendees.map((attendee) => {
            const isFirst = firstTimerSet.has(attendee);
            const initial = attendee.slice(0, 1).toUpperCase();
            const colors = getAttendeeColors(attendee);
            return (
              <li
                class:list={['attendee', isFirst && 'attendee--first']}
                title={attendee}
                style={{
                  '--attendee-bg': colors.bg,
                  '--attendee-fg': colors.fg,
                }}
              >
                <span class="attendee__avatar">
                  <span aria-hidden="true">{initial}</span>
                  {isFirst && (
                    <span class="attendee__new" aria-label="First meat up">
                      ðŸ¥©
                    </span>
                  )}
                </span>
                <span class="attendee__name">{attendee}</span>
              </li>
            );
          })}
        </ul>
      </div>
    )}
  </div>
</li>

<style>
  .event {
    border: 2px solid var(--stark-white);
    padding: var(--space-l);
    display: flex;
    align-items: center;
    gap: var(--space-l);
    background: linear-gradient(
      120deg,
      rgba(255, 255, 255, 0.02),
      rgba(255, 255, 255, 0.005)
    );
  }

  .event--scheduled {
    border-color: var(--mustard-yellow);
    background: linear-gradient(
      120deg,
      rgba(255, 205, 86, 0.12),
      rgba(255, 205, 86, 0.04)
    );
  }

  .event--failed {
    border-color: var(--electric-red);
    background: linear-gradient(
      120deg,
      rgba(224, 79, 95, 0.08),
      rgba(224, 79, 95, 0.02)
    );
  }

  .event-number {
    font-family: var(--font-display);
    font-size: var(--step-5);
    color: var(--mustard-yellow);
  }

  .event-heading {
    display: flex;
    align-items: center;
    gap: var(--space-s);
    flex-wrap: wrap;
  }

  .details h2 {
    font-size: var(--text-section);
  }

  .status-badge {
    padding: var(--space-3xs) var(--space-2xs);
    font-size: var(--text-ui);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    font-weight: 700;
    transform: rotate(-3deg);
    display: inline-block;
  }

  .status-badge--failed {
    border: 2px solid var(--electric-red);
    color: var(--electric-red);
    background: rgba(224, 79, 95, 0.08);
  }

  .status-badge--scheduled {
    border: 2px solid var(--carbon-black);
    background: var(--mustard-yellow);
    color: var(--carbon-black);
    box-shadow: 3px 3px 0px var(--carbon-black);
  }

  .meta {
    display: flex;
    align-items: center;
    gap: var(--space-s);
    margin: var(--space-2xs) 0 var(--space-xs);
    flex-wrap: wrap;
  }

  .details time {
    opacity: 0.7;
    display: inline-block;
  }

  .status-copy {
    font-size: var(--text-ui);
    opacity: 0.7;
  }

  .actions {
    display: flex;
    align-items: center;
    gap: var(--space-s);
    margin: var(--space-s) 0;
    flex-wrap: wrap;
  }

  .secondary-venues {
    list-style: none;
    padding: 0;
    margin: var(--space-s) 0 0;
    opacity: 0.7;
    font-size: var(--step--1);
  }

  .secondary-venues li {
    display: flex;
    align-items: center;
    gap: var(--space-2xs);
    margin: var(--space-3xs) 0;
  }

  .secondary-venues a {
    text-decoration: underline;
  }

  .note {
    margin: var(--space-s) 0 0;
    padding: var(--space-s);
    background: rgba(255, 255, 255, 0.04);
    border: 2px solid var(--stark-white);
    box-shadow: 3px 3px 0px var(--carbon-black);
    font-size: var(--text-ui);
    line-height: 1.4;
  }

  .note--failed {
    border-color: var(--electric-red);
    box-shadow: 3px 3px 0px var(--carbon-black);
    background: rgba(224, 79, 95, 0.08);
  }

  .attendees {
    margin-top: var(--space-m);
  }

  .attendees__label {
    font-size: var(--text-ui);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    opacity: 0.8;
    display: block;
    margin-bottom: var(--space-3xs);
  }

  .attendees__list {
    list-style: none;
    display: flex;
    gap: var(--space-3xs);
    padding: 0;
    flex-wrap: wrap;
    margin: 0;
  }

  .attendee {
    position: relative;
    border: 1px solid var(--stark-white);
    border-radius: 999px;
    font-size: var(--text-ui);
    display: inline-flex;
    align-items: center;
    gap: var(--space-4xs);
    background: rgba(255, 255, 255, 0.02);
    padding: var(--space-5xs) var(--space-5xs);
    transition: background 0.2s ease, box-shadow 0.2s ease;
  }

  .attendee:hover {
    background: rgba(255, 255, 255, 0.1);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
  }

  .attendee__avatar {
    width: 2rem;
    height: 2rem;
    border-radius: 50%;
    display: grid;
    place-items: center;
    background: var(--attendee-bg, var(--carbon-black));
    color: var(--attendee-fg, var(--stark-white));
    font-weight: 700;
    letter-spacing: 0.06em;
    border: 2px solid var(--stark-white);
    transition: transform 0.2s ease;
    position: relative;
    overflow: visible;
  }

  .attendee__name {
    max-width: 0;
    opacity: 0;
    overflow: hidden;
    white-space: nowrap;
    transition: max-width 0.25s ease, opacity 0.2s ease;
  }

  .attendee:hover .attendee__name {
    max-width: 12rem;
    opacity: 1;
    padding-right: var(--space-4xs);
  }

  .attendee:hover .attendee__avatar {
    transform: translateY(-1px);
  }

  .attendee__new {
    position: absolute;
    right: -0.2rem;
    top: -0.3rem;
    background: var(--mustard-yellow);
    color: var(--carbon-black);
    border: 2px solid var(--stark-white);
    border-radius: 999px;
    padding: 0.1rem 0.35rem;
    font-size: 0.65rem;
    font-weight: 800;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    pointer-events: none;
  }
</style>

---
import { getEntry } from 'astro:content';
import EventCard from './EventCard.astro';

const entry = await getEntry('events', 'events');
if (!entry) throw new Error('Events not found');
const upcomingStatuses = new Set(['scheduled']);
const normalizedEvents = entry.data.map((event) => ({
  ...event,
  status: event.status ?? 'scheduled',
  attendees: event.attendees ?? [],
}));

const firstSeen = new Map<string, number>();
const eventsAscending = normalizedEvents
  .toSorted((a, b) => a.date.getTime() - b.date.getTime())
  .map((event) => ({
    ...event,
    attendees: event.attendees ?? [],
  }));

for (const event of eventsAscending) {
  for (const attendee of event.attendees) {
    if (!firstSeen.has(attendee)) {
      firstSeen.set(attendee, event.date.getTime());
    }
  }
}

const eventsDescending = normalizedEvents
  .toSorted((a, b) => b.date.getTime() - a.date.getTime())
  .map((event, index, list) => {
    const firstTimers = event.attendees.filter(
      (attendee) => firstSeen.get(attendee) === event.date.getTime(),
    );

    return {
      ...event,
      eventNumber: list.length - index,
      firstTimers,
    };
  });

const upcomingEvents = eventsDescending
  .filter((event) => upcomingStatuses.has(event.status))
  .toSorted((a, b) => b.date.getTime() - a.date.getTime());

const pastEvents = eventsDescending.filter((event) => !upcomingStatuses.has(event.status));
---

<section class="event-sections">
  {upcomingEvents.length > 0 && (
    <div class="events-group">
      <header class="events-group__header">
        <p class="eyebrow">Upcoming meatings</p>
      </header>
      <ul class="events">
        {upcomingEvents.map((event) => (
          <EventCard {...event} />
        ))}
      </ul>
    </div>
  )}

  {pastEvents.length > 0 && (
    <div class="events-group">
      <header class="events-group__header">
        <p class="eyebrow">Past meatings</p>
      </header>
      <ul class="events">
        {pastEvents.map((event) => (
          <EventCard {...event} />
        ))}
      </ul>
    </div>
  )}
</section>

<style>
  .event-sections {
    display: grid;
    gap: var(--space-xl);
  }

  .events-group {
    display: grid;
    gap: var(--space-m);
  }

  .events-group__header {
    display: grid;
    gap: var(--space-3xs);
  }

  .eyebrow {
    font-size: var(--text-ui);
    letter-spacing: 0.08em;
    text-transform: uppercase;
    opacity: 0.7;
  }

  .events {
    list-style: none;
    padding: 0;
    display: flex;
    flex-direction: column;
    gap: 2rem;
  }
</style>
